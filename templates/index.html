{% extends "base.html" %}

{% block content %}
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
<div class="d-flex align-items-center justify-content-center min-vh-100 bg-corporate text-white">
    <div class="container text-center">
        <!-- Hero Section -->
        <div class="mb-5">
            <h1 class="display-4 fw-bold mb-3">Device Tracking</h1>
            <p class="lead text-light opacity-75">Εισάγετε τον κωδικό της συσκευής σας (π.χ. SERxxxxxx)</p>
        </div>

        <!-- Search Box -->
        <div class="row justify-content-center mb-5">
            <div class="col-md-8 col-lg-6">
                <div class="input-group input-group-lg shadow-lg">
                    <input type="text" id="trackInput" class="form-control border-0 text-center text-uppercase fs-4"
                        placeholder="SERxxxxxx" aria-label="Tracking ID">
                    <button class="btn btn-warning fw-bold text-dark px-4" type="button" onclick="searchDevice()">
                        <i class="fas fa-search me-2"></i>Αναζήτηση
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Container (Hidden by default) -->
        <div id="resultContainer" class="d-none text-start mx-auto shadow-lg" style="max-width: 700px;">
            <div class="card bg-white text-dark border-0 rounded-3 overflow-hidden">
                <div class="card-header bg-light border-bottom p-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h2 id="deviceModel" class="h3 fw-bold mb-1 text-primary">Μοντέλο Συσκευής</h2>
                        <span id="currentStatus" class="badge bg-success rounded-pill px-3">Κατάσταση</span>
                    </div>
                    <div id="mainStatusAnim" style="width: 80px; height: 80px;">
                        <!-- Animation -->
                    </div>
                </div>
                <div class="card-body p-4 text-dark">
                    <!-- Timeline -->
                    <div class="timeline position-relative" id="timelineList">
                        <!-- Items injected here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed-bottom text-end p-4">
            <a href="{{ url_for('login') }}"
                class="text-white text-decoration-none small opacity-75 hover-opacity-100"><i
                    class="fas fa-user-lock me-1"></i>Προσωπικό Login</a>
        </div>
    </div>
</div>

<style>
    .bg-soft-success {
        background-color: rgba(25, 135, 84, 0.1) !important;
        color: #198754 !important;
    }

    .timeline {
        border-left: 2px solid #dee2e6;
        padding-left: 2rem;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 2rem;
    }

    .timeline-icon {
        position: absolute;
        left: -2.9rem;
        top: 0;
        background: #fff;
        padding: 5px;
        border-radius: 50%;
        border: 2px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    async function searchDevice() {
        const input = document.getElementById('trackInput');
        const container = document.getElementById('resultContainer');
        const id = input.value.trim();

        if (!id) return;

        try {
            const res = await fetch(`/track?id=${id}`);
            const data = await res.json();

            if (!res.ok) {
                Swal.fire({
                    icon: 'error',
                    title: 'Δεν βρέθηκε',
                    text: 'Η συσκευή με αυτόν τον κωδικό δεν βρέθηκε.',
                });
                return;
            }

            // Populate Data
            document.getElementById('deviceModel').textContent = (data.device.brand ? data.device.brand + ' ' : '') + data.device.model;
            document.getElementById('currentStatus').textContent = data.device.status;

            // ANIMATION MAPPING
            const animMap = {
                'Παραλήφθηκε': 'https://assets5.lottiefiles.com/packages/lf20_j1adxtyb.json', // Box/Package
                'Υπό Έλεγχο': 'https://assets8.lottiefiles.com/packages/lf20_iorpbol0.json', // Search/Check
                'Υπό Επισκευή': 'https://assets10.lottiefiles.com/packages/lf20_w51pcehl.json', // Tools/Repair (Orange)
                'Έτοιμο': 'https://assets9.lottiefiles.com/packages/lf20_s2lryxtd.json', // Checkmark/Success
                'Αρχείο': 'https://assets3.lottiefiles.com/packages/lf20_xYF7kG.json' // Delivery/Handshake
            };

            // Main Status Animation
            const mainAnimUrl = animMap[data.device.status] || animMap['Παραλήφθηκε'];
            document.getElementById('mainStatusAnim').innerHTML = `
                <lottie-player src="${mainAnimUrl}" background="transparent" speed="1" style="width: 80px; height: 80px;" loop autoplay></lottie-player>
            `;

            const timelineList = document.getElementById('timelineList');
            timelineList.innerHTML = data.device.timeline.map((item, index) => {
                const animUrl = animMap[item.status];

                // Smart merging for UI: If note exists but status is same as previous (handled backend), handle visuals?
                // Backend already filters exact duplicates without notes.

                const iconHtml = animUrl
                    ? `<lottie-player src="${animUrl}" background="transparent" speed="1" style="width: 40px; height: 40px;" loop autoplay></lottie-player>`
                    : `<div class="bg-secondary rounded-circle" style="width: 32px; height: 32px;"></div>`;

                return `
            <div class="timeline-item d-flex align-items-start">
                <div class="timeline-icon d-flex align-items-center justify-content-center bg-white shadow-sm border-0">
                    ${iconHtml}
                </div>
                <div class="ms-4 w-100 bg-light p-3 rounded shadow-sm border-start border-3 border-primary">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h5 class="mb-0 fw-bold text-dark">${item.status}</h5>
                        <span class="badge bg-white text-primary border shadow-sm">${item.date}</span>
                    </div>
                    ${item.note ? `<p class="text-secondary small mb-1 mt-2 bg-white p-2 rounded border"><i class="fas fa-info-circle me-1"></i>${item.note}</p>` : ''}
                    <div class="text-end text-muted text-xs mt-1">Updated by ${item.staff}</div>
                </div>
            </div>
            `;
            }).join('');

            container.classList.remove('d-none');

        } catch (e) {
            console.error(e);
            Swal.fire('Σφάλμα', 'Πρόβλημα επικοινωνίας', 'error');
        }
    }
</script>
{% endblock %}